<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Detail Destinasi - SUMTOUR</title>
    <link rel="stylesheet" href="../../css/destinasi-detail.css" />
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
  </head>
  <body>
    <!-- Header -->
    <header>
      <div class="container header-container">
        <div class="logo">
          <img
            src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTIwIDBDOC45NTQgMCAwIDguOTU0IDAgMjBTOC45NTQgNDAgMjAgNDBTNDAgMzEuMDQ2IDQwIDIwUzMxLjA0NiAwIDIwIDBaIiBmaWxsPSIjMzQ5OGRiIi8+CjxwYXRoIGQ9Ik0xNiAxNkgyNFYyNEgxNlYxNloiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik0yNCAyNEgyNlYyNkgyNFYyNFoiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik0yNiAyNkgyOFYyOEgyNlYyNloiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik0yOCAyOEgzMFYzMEgyOFYyOFoiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik0xNiAyNEgxNFYyNkgxNlYyNFoiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik0xNCAyNkgxMlYyOEgxNFYyNloiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik0xMiAyOEgxMFYzMEgxMlYyOFoiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik0yNiAxNkgyOFYxOEgyNlYxNloiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik0yOCAxOEgzMFYyMEgyOFYxOFoiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik0xNCAxNkgxNlYxOEgxNFYxNloiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik0xMiAxOEgxNFYyMEgxMlYxOFoiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo="
            alt="SUMTOUR Logo"
          />
          <h1>SUMTOUR</h1>
        </div>
        <nav>
          <ul>
            <li><a href="../index.html">Beranda</a></li>
            <li><a href="destinasi.html">Destinasi</a></li>
            <li><a href="../guide/tour-guide.html">Tour Guide</a></li>
            <li><a href="../user/riwayat.html">Riwayat</a></li>
            <li><a href="../tentang.html">Tentang</a></li>
          </ul>
        </nav>
        <div class="user-actions" id="userActions">
          <!-- Akan diisi oleh JavaScript -->
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <div class="main-content">
      <div class="container">
        <!-- Back Button -->
        <div class="back-button">
          <a href="destinasi.html">‚Üê Kembali ke Destinasi</a>
        </div>

        <!-- Destinasi Detail -->
        <div class="destinasi-detail" id="destinasiDetail">
          <!-- Data destinasi akan diisi oleh JavaScript -->
        </div>
      </div>
    </div>

    <!-- Bagian komentar -->
    <div class="komentar-section" id="komentarSection">
      <h3>üí¨ Komentar</h3>

      <div class="komentar-form">
        <textarea id="komentarInput" placeholder="Tulis komentar Anda..." rows="3"></textarea>
        <button onclick="kirimKomentar()">Kirim</button>
      </div>

      <div id="renderKomentar">
        <!-- Komentar akan dirender di sini -->
      </div>
    </div>

    <!-- Footer -->
    <footer>
      <div class="container">
        <div class="footer-content">
          <div class="footer-column">
            <h3>Tentang SUMTOUR</h3>
            <p>SUMTOUR adalah platform rekomendasi wisata di Sumatera Barat yang membantu wisatawan menemukan destinasi terbaik sesuai minat mereka.</p>
            <div class="social-links">
              <a href="#"><span>FB</span></a>
              <a href="#"><span>IG</span></a>
              <a href="#"><span>TW</span></a>
              <a href="#"><span>YT</span></a>
            </div>
          </div>
          <div class="footer-column">
            <h3>Kontak Kami</h3>
            <p><span>üìç</span> Jl. Prof. Dr. Hamka, Air Tawar Barat, Padang Utara, Kota Padang</p>
            <p><span>üìû</span> +62 812 3456 7890</p>
            <p><span>‚úâÔ∏è</span> info@sumtour.id</p>
          </div>
          <div class="footer-column">
            <h3>Link Cepat</h3>
            <a href="../index.html">Beranda</a>
            <a href="destinasi.html">Destinasi Wisata</a>
            <a href="../guide/tour-guide.html">Tour Guide</a>
            <a href="../user/riwayat.html">Riwayat Saya</a>
            <a href="../tentang.html">Tentang Kami</a>
          </div>
        </div>
        <div class="copyright">
          <p>&copy; 2025 SUMTOUR - Web Aplikasi Rekomendasi Wisata di Sumatera Barat. All rights reserved.</p>
          <p>Disusun oleh: Florensius Panca Gati (23343006) & Meli Fitri Zamili (23343010)</p>
        </div>
      </div>
    </footer>

    <script>
      // Fungsi untuk menampilkan detail destinasi
      async function displayDestinasiDetail() {
        const destinasiDetail = document.getElementById("destinasiDetail");
        // Ambil ID dari URL
        const params = new URLSearchParams(window.location.search);
        const id = params.get("id");

        let komentarState = [];

        if (!id) {
          destinasiDetail.innerHTML = `
            <div style="padding: 40px; text-align: center;">
              <h3>ID Destinasi tidak ditemukan</h3>
              <a href="destinasi.html" style="color: #3498db;">Kembali ke Destinasi</a>
            </div>`;
          return;
        }

        // Ambil data dari backend
        let response;
        try {
          response = await fetch(`http://localhost:3000/destinasi/public/${id}`);
        } catch (err) {
          console.error(err);
        }

        const result = await response.json();

        if (!result.success || !result.data) {
          destinasiDetail.innerHTML = `
            <div style="padding: 40px; text-align: center;">
              <h3>Destinasi tidak ditemukan di database</h3>
              <a href="destinasi.html" style="color: #3498db;">Kembali ke Destinasi</a>
            </div>`;
          return;
        }

        const selectedDestinasi = result.data; // **INI DATA DARI BACKEND**
        // üî• RENDER KOMENTAR DARI BACKEND
        komentarState = selectedDestinasi.komentar || [];
        renderKomentar(komentarState);


        // SIMPAN KE LOCALSTORAGE (opsional, untuk fitur lain)
        localStorage.setItem("selectedDestinasi", JSON.stringify(selectedDestinasi));

        // Render tampilan (kode kamu tetap dipakai)
        destinasiDetail.innerHTML = `
                <div class="destinasi-header">
                    <h1>${selectedDestinasi.nama}</h1>
                    <div class="destinasi-meta">
                        <div class="meta-item">
                            <span>üìç</span>
                            <span>${selectedDestinasi.lokasi}</span>
                        </div>
                        <div class="meta-item">
                            <span>üí∞</span>
                            <span>${selectedDestinasi.harga}</span>
                        </div>
                    </div>
                    <span class="destinasi-category">${getKategoriName(selectedDestinasi.kategori)}</span>
                </div>

                <div class="destinasi-content">
                    <div class="left-column">
                        <div class="gallery-section">
                            <img src="http://localhost:3000/images_destinasi/${selectedDestinasi.gambar}" alt="${selectedDestinasi.nama}" class="main-image" id="mainImage">
                        </div>

                        <div class="description-section">
                            <h3>Deskripsi</h3>
                            <p>${selectedDestinasi.deskripsi}</p>
                        </div>

                    </div>

                    <div class="right-column">
                        <div class="info-card">
                            <h4>üìç Informasi Lokasi</h4>
                            <div class="info-item">
                                <span class="info-label">Alamat:</span>
                                <span class="info-value">${selectedDestinasi.lokasi}, Sumatera Barat</span>
                            </div>
                        </div>

                        <div class="info-card">
                            <h4>üí∞ Biaya Masuk</h4>
                            <div class="info-item">
                                <span class="info-label">Tiket:</span>
                                <span class="info-value">${selectedDestinasi.harga}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Parkir:</span>
                                <span class="info-value">Rp 5.000 - Rp 10.000</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="map" class="map-section" style="height: 450px; border-radius: 20px;"></div>
            `;
        
        // Setelah HTML dirender
        setTimeout(() => {
          initMap(selectedDestinasi.latitude, selectedDestinasi.longitude, selectedDestinasi.nama);
        }, 200);
      }

      // fungsi map
      // MAPBOX
      function initMap(lat, lng, name) {
        mapboxgl.accessToken = 'pk.eyJ1IjoiZmxvcmVuc2l1cyIsImEiOiJjbWg3c3c5YzcwcTdyMnhwdTVreW1qdXRsIn0.LmgVCoaMP5r1SRvnvVggrQ';

        const map = new mapboxgl.Map({
          container: 'map',  // ID dari div peta
          style: 'mapbox://styles/mapbox/satellite-streets-v12',
          center: [lng, lat],
          zoom: 13
        });

        new mapboxgl.Marker()
          .setLngLat([lng, lat])
          .setPopup(new mapboxgl.Popup().setText(name))
          .addTo(map);
      }

      // Fungsi untuk mendapatkan nama kategori
      function getKategoriName(kategori) {
        const kategoriMap = {
          alam: "Wisata Alam",
          budaya: "Wisata Budaya",
          kuliner: "Wisata Kuliner",
          sejarah: "Wisata Sejarah",
        };
        return kategoriMap[kategori] || kategori;
      }

      // Fungsi kirim komentar
      async function kirimKomentar() {
          // Cek token di localStorage (frontend masih menggunakan localStorage)
          const token = localStorage.getItem("token");
          console.log("=== KIRIM KOMENTAR ===");
              
          // Cek semua localStorage
          console.log("LocalStorage items:");
          for (let i = 0; i < localStorage.length; i++) {
              const key = localStorage.key(i);
              const value = localStorage.getItem(key);
              console.log(key + ":", key === 'token' ? value?.substring(0, 50) + '...' : value);
          }
              
          if (!token) {
              console.error("‚ùå Token tidak ditemukan di localStorage!");
              alert("Token tidak ditemukan. Silakan login ulang.");
              return;
          }
          
          console.log("‚úÖ Token ditemukan, length:", token.length);

          const textarea = document.getElementById("komentarInput");
          const isi = textarea.value.trim();
          if (!isi) return alert("Komentar tidak boleh kosong!");

          const selectedDestinasi = JSON.parse(localStorage.getItem("selectedDestinasi"));
          if (!selectedDestinasi || !selectedDestinasi._id) {
              alert("Destinasi tidak ditemukan!");
              return;
          }

          try {
              // PERHATIAN: Karena backend menggunakan cookies, tidak perlu Authorization header
              // TAPI frontend Anda mengirim token di localStorage, jadi kita perlu sesuaikan
              
              // Opsi 1: Jika backend membaca dari cookies, tidak perlu header Authorization
              const res = await fetch(`http://localhost:3000/destinasi/${selectedDestinasi._id}/komentar`,
                  {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                      "Authorization": `Bearer ${token}` // üî• INI YANG HILANG
                    },
                    body: JSON.stringify({ isi })
                  }
                );

              // const res = await fetch(`http://localhost:3000/destinasi/${selectedDestinasi._id}/komentar`, {
              //     method: "POST",
              //     headers: { 
              //         "Content-Type": "application/json"
              //         // JANGAN kirim Authorization header karena Anda menggunakan cookies
              //     },
              //     body: JSON.stringify({ isi }),
              //     credentials: 'include' // Penting! Untuk mengirim cookies
              // });

              // Opsi 2: Jika ingin tetap pakai Authorization header, ubah middleware:
              // middleware auth Anda harus cek header JIKA tidak ada cookies

              if (!res.ok) {
                  if (res.status === 401) {
                      alert("Sesi Anda telah habis, silakan login kembali!");
                      localStorage.removeItem("token");
                     //  window.location.href = "../auth/login.html";
                      return;
                  }
                  const errData = await res.json();
                  throw new Error(errData.error || "Gagal mengirim komentar");
              }

              const result = await res.json();
              textarea.value = "";
              
              // Render ulang semua komentar
              komentarState = result.data.komentar;
              renderKomentar(komentarState);

              
          } catch (err) {
              console.error("Error kirimKomentar:", err);
              alert("Gagal mengirim komentar: " + err.message);
          }
      }

      function renderKomentar(komentarList) {
        const token = localStorage.getItem("token");
        let currentUserId = null;

        if (token) {
          try {
            const payload = JSON.parse(atob(token.split(".")[1]));
            currentUserId = payload.userId || payload.id || payload._id;
          } catch (e) {
            console.warn("Token invalid");
          }
        }

        const container =
          document.getElementById("renderKomentar") ||
          document.getElementById("daftarKomentar");

        if (!container) {
          console.error("Container komentar tidak ditemukan!");
          return;
        }

        if (!komentarList || komentarList.length === 0) {
          container.innerHTML =
            "<p class='no-comment'>Belum ada komentar. Jadilah yang pertama berkomentar!</p>";
          return;
        }

        const sortedKomentar = [...komentarList].sort(
          (a, b) => new Date(b.tanggal) - new Date(a.tanggal)
        );

        container.innerHTML = sortedKomentar.map(k => `
            <div class="komentar-item" data-id="${k._id}">
              <strong>${k.nama}</strong>
              <span>(${formatTanggal(k.tanggal)})</span>

              <p 
                class="komentar-isi" 
                id="komentar-${k._id}"
                data-original="${k.isi}"
                contenteditable="false"
              >
                ${k.isi}
              </p>

              ${
                k.userId === currentUserId
                  ? `
                    <div class="komentar-actions">
                      <button onclick="startEditKomentar('${k._id}')">‚úè Edit</button>
                      <button onclick="hapusKomentar('${k._id}')">üóë Hapus</button>
                    </div>
                  `
                  : ""
              }
            </div>
          `).join("");
      }
      
      // Helper function untuk format tanggal
      function formatTanggal(tanggal) {
          const date = new Date(tanggal);
          return date.toLocaleDateString('id-ID', {
              day: 'numeric',
              month: 'short',
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
          });
      }

      function startEditKomentar(idKomentar) {
        const p = document.getElementById(`komentar-${idKomentar}`);
        if (!p) return;

        p.contentEditable = "true";
        p.focus();

        // Pindahkan cursor ke akhir teks
        const range = document.createRange();
        const sel = window.getSelection();
        range.selectNodeContents(p);
        range.collapse(false);
        sel.removeAllRanges();
        sel.addRange(range);

        const actionDiv = p.closest(".komentar-item").querySelector(".komentar-actions");

        actionDiv.innerHTML = `
          <button onclick="saveEditKomentar('${idKomentar}')">üíæ Simpan</button>
          <button onclick="cancelEditKomentar('${idKomentar}')">‚ùå Batal</button>
        `;
      }

      function cancelEditKomentar(idKomentar) {
        const p = document.getElementById(`komentar-${idKomentar}`);
        if (!p) return;

        p.textContent = p.dataset.original;
        p.contentEditable = "false";

        resetActionButtons(idKomentar);
      }

      async function saveEditKomentar(idKomentar) {
        const token = localStorage.getItem("token");
        const p = document.getElementById(`komentar-${idKomentar}`);
        const newIsi = p.textContent.trim();
        if (!newIsi) return alert("Komentar tidak boleh kosong");

        const destinasi = JSON.parse(localStorage.getItem("selectedDestinasi"));

        const res = await fetch(
          `http://localhost:3000/destinasi/${destinasi._id}/komentar/${idKomentar}`,
          {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`
            },
            body: JSON.stringify({ isi: newIsi })
          }
        );

        const result = await res.json();
        if (!res.ok) return alert(result.error || "Gagal update komentar");

        p.dataset.original = newIsi;
        p.contentEditable = "false";

        resetActionButtons(idKomentar);
      }

      function resetActionButtons(idKomentar) {
        const actionDiv = document
          .querySelector(`[data-id="${idKomentar}"] .komentar-actions`);

        actionDiv.innerHTML = `
          <button onclick="startEditKomentar('${idKomentar}')">‚úè Edit</button>
          <button onclick="hapusKomentar('${idKomentar}')">üóë Hapus</button>
        `;
      }

      async function hapusKomentar(idKomentar) {
        if (!confirm("Yakin ingin menghapus komentar ini?")) return;

        const destinasi = JSON.parse(localStorage.getItem("selectedDestinasi"));
        const token = localStorage.getItem("token");

        try {
          const res = await fetch(
            `http://localhost:3000/destinasi/${destinasi._id}/komentar/${idKomentar}`,
            {
              method: "DELETE",
              headers: {
                Authorization: `Bearer ${token}`
              }
            }
          );

          if (!res.ok) {
            const err = await res.json();

            // üîê user mencoba hapus komentar orang lain
            if (res.status === 403) {
              alert("Anda tidak berhak menghapus komentar ini!");
              return;
            }

            throw new Error(err.error || "Gagal menghapus komentar");
          }

          const result = await res.json();

          // üîÑ render ulang komentar setelah hapus
          komentarState = result.data;
          renderKomentar(komentarState);

        } catch (err) {
          console.error("Error hapus komentar:", err);
          alert(err.message);
        }
      }

      // Fungsi untuk mengatur tampilan user actions
      function setupUserActions() {
        const userActions = document.getElementById("userActions");
        const isLoggedIn = localStorage.getItem("isLoggedIn");
        const username = localStorage.getItem("username");

        if (isLoggedIn === "true" && username) {
          userActions.innerHTML = `
                    <div class="user-info">
                        <span>Halo, ${username}</span>
                        <button class="logout-btn" onclick="logout()">Logout</button>
                    </div>
                `;
        } else {
          userActions.innerHTML = `
                    <a href="../auth/register.html">Daftar</a>
                    <a href="../auth/login.html" class="login-btn">Masuk</a>
                `;
        }
      }

      // Fungsi logout
      function logout() {
        if (confirm("Apakah Anda yakin ingin logout?")) {
          localStorage.removeItem("token");
          localStorage.removeItem("isLoggedIn");
          localStorage.removeItem("user_role");
          localStorage.removeItem("username");
          localStorage.removeItem("admin_logged_in");
          alert("Logout berhasil!");
          window.location.href = "../index.html";
        }
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", function () {
        displayDestinasiDetail();
        setupUserActions();
      });
    </script>
  </body>
</html>
